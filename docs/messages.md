# Messages and message envelopes

## Message

Message class is a base structure for all data streams inside the constellation.

**Message** structure:

- **`messageId`** (`Int64`) - Message identifier. Message results refer to original messages 
using those identifiers.

Additional data depends on the message type.

**HandshakeRequest** message used to verify that specified public key belongs to client/auditor. Initiated by 
alpha. Structure:

- **`handshakeData`** (`Array<byte>`) - Random 32 byte array sent by Alpha. 


### Client messages

**HandshakeResponse** message is a respond to **HandshakeRequest**. Structure:

- **`handshakeData`** (`Array<byte>`) - Random 32 byte array generated by Alpha and signed by the client. 


**ClientConnectionSuccess** is a message that alpha will send on successful client connection, inherits
 **ResultMessageBase**, structure:

- **`accountId`** (`UInt64`) - Current client id. Message sent by alpha after successful handshake.


**ResultMessageBase** - base message for all results. Structure:

- **`originalMessage`** (`MessageEnvelopeBase`) - Original request envelope.
- **`status`** (`ResultStatusCode`) - Last known result apex to start sync from.
- **`errorMessage`** (`string`) - Request handling error.


**ResultStatusCode** values:
- `Success` = `200`
- `BadRequest` = `400`
- `Unauthorized` = `401`
- `Forbidden` = `403`
- `PayloadTooLarge` = `413`
- `TooManyRequests` = `429`
- `InvalidState` = `450`
- `InternalError` = `500`
- `SnapshotValidationFailed` = `550`
- `UnexpectedMessage` = `551`


All result messages inherit **ResultMessageBase**. For all requests that is not quantum client will receive 
**ResultMessage**. For all quantum requests **QuantumResultMessageBase** will be sent.


**QuantumResultMessageBase** is abstract base result class for all quantum results, it implements 
**IQuantumInfoContainer** interface. All quantum result messages you can find in [**quantum flow doc**](docs/messages.md). 
**IQuantumInfoContainer** structure:

- **`apex`** (`UInt64`) - Quantum apex.
- **`quantumHash`** (`Array<byte>`) - Quantum SHA256 hash.
- **`payloadProof`** (`PayloadProof`) - Quantum payload proof.
- **`effects`** (`Array<EffectsInfoBase>`) - Array of all effects that occurred during quantum processing. 


**PayloadProof** contains data to verify that auditors have processed the quantum. Structure:

- **`payloadHash`** (`Array<byte>`) - SHA256 hash of concatenated apex bytes, quantum and effects hash.
- **`signatures`** (`Array<Array<byte>>`) - Array of payload hash signatures.


**EffectsInfoBase** is a base class for validating effects on a client-side. For the effects that belong to the 
client, alpha will send **EffectsInfo**. It contains serialized **EffectsGroup**. For all other effects, 
**EffectsHashInfo** will be sent. **EffectsHashInfo** only contains an effects group hash.  **EffectsInfoBase** structure:

- **effectsGroupData** (`Array<byte>`) - effects group data.


**EffectsGroup** structure:

- **`account`** (`UInt64`) - Account id.
- **`accountSequence`** (`UInt64`) - Account sequence.
- **`effects`** (`Array<Effect>`) - Array of effects ([**Effects**](docs/effects.md))


Client can request own quanta infos with **QuantumInfoRequest**. Structure:

- **`cursor`** (`String`) - Result cursor.
- **`string`** (`Order`) - Query direction, `ASC` or `DESC`.
- **`limit`** (`UInt32`) - Max batch size.


Alpha will send **QuantumInfoResponse**. Structure:

- **`items`** (`Array<QuantumInfo>`) - Quantum info items.
- **`currentPagingToken`** (`string`) - Current batch pagination token.
- **`nextPageToken`** (`string`) - Next page token.
- **`prevPageToken`** (`string`) - Previous page token.
- **`string`** (`Order`) - Result direction, `ASC` or `DESC`.
- **`limit`** (`UInt32`) - Max batch size.


If some quantum changes state of an account, alpha will send **EffectsNotification** message. It implements 
**IQuantumInfoContainer** and doesn't have additional fields.


### Internal messages

**AuditorHandshakeResponse** - respond to **HandshakeRequest** with additional auditor data. Structure:

- **`handshakeData`** (`Array<byte>`) - Random 32 byte array generated by Alpha and signed by the auditor. 
- **`quantaCursor`** (`UInt64`) - Last known quantum apex to start sync from.
- **`resultCursor`** (`UInt64`) - Last known result apex to start sync from.
- **`state`** (`State`) - Current auditor state.


On every state changes, auditor sends **StateUpdateMessage** to constellation. **StateUpdateMessage** structure:
- **`state`** (`State`) - Auditor current state. 


**State** values:
- `Undefined` = `0` - Auditor is not initialized yet.
- `Running` = `1` - Auditor is running, but not ready to accept client connections.
- `Ready` = `2` - Auditor is ready to handle quantum requests.
- `Rising` = `3` - Auditor is collecting and validating pending quanta.
- `Chasing` = `4` - Auditor is too delayed and is in sync mode.
- `Failed` = `10` - Auditor failed.
- `Stopped` = `20` - Auditor is about to stop.


Each auditor streams its results to constellation by sending **AuditorResultsBatch**. Structure:
- **`auditorResultMessages`** (`Array<AuditorResult>`) - Array of quantum results. 


**AuditorResult** structure:

- **`apex`** (`UInt64`) - Quantum apex.
- **`signature`** (`AuditorSignatureInternal`) - Auditor's signature.


**AuditorSignatureInternal** structure:

- **`auditorId`** (`Int32`) - Auditors id (index in constellation settings)
- **`signature`** (`Array<byte>`) - Signature.
- **`txSigner`** (`Array<byte>`) - Withdrawal signer.
- **`txSignature`** (`Array<byte>`) - Withdrawal signature.


**QuantaBatchRequest** structure:

- **`quantaCursor`** (`UInt64`) - Last known quantum apex to start sync from.
- **`resultCursor`** (`UInt64`) - Last known result apex to start sync from.


**QuantaBatch** structure:

- **`quanta`** (`Array<Quantum>`) - Array of quanta.
- **`signatures`** (`Array<QuantumSignatures>`) - Array of collected signatures.
- **`lastKnownApex`** (`UInt64`) - Last known apex.


**QuantumSignatures** structure:

- **`apex`** (`UInt64`) - Quantum apex.
- **`signatures`** (`Array<AuditorSignatureInternal>`) - Auditor signatures.

## Message envelope

Every message is wrapped with envelope. There are three types of message envelope in Centaurus:
**MessageEnvelope**, **MessageEnvelopeSignless** and **ConstellationMessageEnvelope**. Each of it inherit 
**MessageEnvelopeBase**.


**MessageEnvelopeBase** structure:

- **`message`** (`Message`) - nested message.


**MessageEnvelope** contains single signature and used for sending any request that must be authorized. 
Structure: 
	
- **`signature`** (`Array<byte>`) - Message hash signature.


**MessageEnvelopeSignless** doesn't contain signature and used for messages that already contains 
signatures/proofs in the message itself. 


**ConstellationMessageEnvelope** is a type of envelope that used for all constellation quantum requests. 
Structure: 

- **`signatures`** (`Array<Array<byte>>`) - Auditor signatures.