# Messages and message envelopes

## Message

Message class is a base structure for all data streams inside the constellation.

**Message** structure:

- **`messageId`** (`Int64`) - Message identifier. Message results refer to original messages 
using those identifiers.

Additional data depends on the message type.

**HandshakeRequest** message used to verify that specified public key belongs to client/auditor. Initiated by 
alpha. Structure:

- **`handshakeData`** (`Array<byte>`) - Random 32 byte array sent by Alpha. 

## Quantum structure

All messages are inherited from **Message**. All quantum messages are inherited from 
**Quantum**. 

**Quantum** structure: 

- **`apex`** (`UInt64`) - The most recent quantum apex (sequence).
- **`prevHash`** (`Array<byte>`) - Previous quantum SHA256 hash.
- **`effectsProof`** (`Array<byte>`) - All quantum effects SHA256 hash.
- **`timestamp`** (`Int64`) - Alpha server timestamp when the quantum has been fully executed 
on Alpha.

### Client messages

All result messages inherit **ResultMessageBase**. For all requests that is not quantum, or if quantum is 
invalid, client will receive **ResultMessage**. 

**ResultMessageBase** structure:

- **`originalMessageId`** (`Int64`) - Original request message id.
- **`status`** (`ResultStatusCode`) - Last known result apex to start sync from.
- **`errorMessage`** (`string`) - Request handling error.

**ResultStatusCode** values:
- `Success` = `200`
- `BadRequest` = `400`
- `Unauthorized` = `401`
- `Forbidden` = `403`
- `PayloadTooLarge` = `413`
- `TooManyRequests` = `429`
- `InvalidState` = `450`
- `InternalError` = `500`
- `UnexpectedMessage` = `551`


**ClientConnectionSuccess** is a message that alpha will send on successful client connection, inherits
 **ResultMessageBase**, structure:

- **`accountId`** (`UInt64`) - Current client id. Message sent by alpha after successful handshake.


**HandshakeResponse** message is a respond to **HandshakeRequest**. Structure:

- **`handshakeData`** (`Array<byte>`) - Random 32 byte array generated by Alpha and signed by the client. 


Client can request own quanta infos with **QuantumInfoRequest**. Structure:

- **`cursor`** (`String`) - Result cursor.
- **`string`** (`Order`) - Query direction, `ASC` or `DESC`.
- **`limit`** (`UInt32`) - Max batch size.


Alpha will send **QuantumInfoResponse**. Structure:

- **`items`** (`Array<QuantumInfo>`) - Quantum info items.
- **`currentPagingToken`** (`string`) - Current batch pagination token.
- **`nextPageToken`** (`string`) - Next page token.
- **`prevPageToken`** (`string`) - Previous page token.
- **`string`** (`Order`) - Result direction, `ASC` or `DESC`.
- **`limit`** (`UInt32`) - Max batch size.


**QuantumInfo** structure:

- **`apex`** (`UInt64`) - Quantum apex.
- **`request`** (`RequestInfoBase`) - Request data.
- **`items`** (`Array<EffectsInfoBase>`) - Array of effects data.
- **`proof`** (`Array<byte[]>`) - Array of payload hash signatures.
- **`timestamp`** (`Int64`) - Quantum timestamp.

#### Client quanta

All client quantum requests are inherited from **SequentialRequestMessage**. 

**SequentialRequestMessage** structure: 

- **`account`** (`UInt64`) - Account id.
- **`nonce`** (`UInt64`) - A sequential nonce provided by the client to prevent replay attacks.

Alpha wraps **SequentialRequestMessage** with sub class 
of **RequestQuantumBase**. In most cases client requests would be wrapped with 
**RequestQuantum**, that implements **RequestQuantumBase** and doesn't have any fields. All other cases are 
described below.

**RequestQuantumBase** structure: 

- **`requestEnvelope`** (`MessageEnvelopeBase`) - Original operation request received from a 
client.


**AccountDataRequest** doesn't have any fields, but it will be wrapped with **AccountDataRequestQuantum** 
with following structure:

- **`payloadHash`** (`Array<byte>`) - Account's current state SHA256 hash.


If **AccountDataRequestQuantum** successfully processed by constellation, the client will receive **AccountDataResponse** with the next structure:

- **`balances`** (`Array<Balance>`) - All account's balances.
- **`orders`** (`Array<Order>`) - All active account's orders.
- **`sequence`** (`UInt64`) - Account's sequence.


**Balance** structure:

- **`asset`** (`string`) - Centaurus asset code.
- **`amount`** (`UInt64`) - Balance amount.
- **`liabilities`** (`UInt64`) - Balance liabilities.


**Order** structure:

- **`asset`** (`string`) - Centaurus asset code.
- **`side`** (`Int32`) - Order side. `Sell = 1` and `Buy = 2`.
- **`amount`** (`UInt64`) - Asset order amount.
- **`quoteAmount`** (`UInt64`) - Quote order amount.
- **`price`** (`Float64`) - Asset price.
- **`timeInForce`** (`Int32`) - Order type. `GoodTillExpire = 0, ImmediateOrCancel = 1`.
- **`orderId`** (`UInt64`) - Order id.


**PaymentRequest** structure:

- **`asset`** (`string`) - Centaurus asset code.
- **`amount`** (`UInt64`) - Payment amount.
- **`destination`** (`Array<byte>`) - Destination public key.

**WithdrawalRequest** structure:

- **`provider`** (`string`) - Payment provider id.
- **`asset`** (`string`) - Centaurus asset code.
- **`amount`** (`UInt64`) - Payment amount.
- **`destination`** (`Array<byte>`) - Destination public key.
- **`fee`** (`UInt64`) - Transaction fee.

**WithdrawalRequest** will be wrapped with **WithdrawalRequestQuantum** with structure:

- **`transaction`** (`Array<byte>`) - Withdrawal transaction.
- **`provider`** (`string`) - Payment provider id.

**OrderRequest** structure:

- **`asset`** (`string`) - Centaurus asset code.
- **`side`** (`Int32`) - Order side. `Sell = 1` and `Buy = 2`
- **`amount`** (`UInt64`) - Order amount.
- **`price`** (`Float64`) - Asset price.
- **`timeInForce`** (`Int32`) - Order type. `GoodTillExpire = 0, ImmediateOrCancel = 1`.

**OrderCancellationRequest** structure:

- **`orderId`** (`UInt64`) - Order to cancel id.

If client quantum request is processed successfully, alpha will send result that inherited from 
**QuantumResultMessageBase**.

**QuantumResultMessageBase** is abstract base result class for all quantum results, it implements 
**IQuantumInfoContainer** interface. **IQuantumInfoContainer** structure:

- **`apex`** (`UInt64`) - Quantum apex.
- **`request`** (`RequestInfoBase`) - Quantum data..
- **`payloadProof`** (`PayloadProof`) - Quantum payload proof.
- **`effects`** (`Array<EffectsInfoBase>`) - Array of all effects that occurred during quantum processing. 

**RequestInfoBase** contains data about quantum request. If the account is the initiator of the request, than 
**RequestInfo** would be sent. **RequestInfo** contains serialized quantum. If account was affected by the 
quantum, but didn't initiate it, than the account receives **RequestHashInfo**, that only contains quantum hash.

**RequestInfoBase** structure:

- **`data`** (`Array<byte>`) - Quantum data.


**PayloadProof** contains data to verify that auditors have processed the quantum. Structure:

- **`payloadHash`** (`Array<byte>`) - SHA256 hash of concatenated apex bytes, quantum and effects hash.
- **`signatures`** (`Array<Array<byte>>`) - Array of payload hash signatures.


**EffectsInfoBase** is a base class for validating effects on a client-side. For the effects that belong to the 
account, alpha will send **EffectsInfo**. It contains serialized **EffectsGroup**. For all other effects, 
**EffectsHashInfo** will be sent. **EffectsHashInfo** only contains an effects group hash.  **EffectsInfoBase** structure:

- **effectsGroupData** (`Array<byte>`) - effects group data.


**EffectsGroup** structure:

- **`account`** (`UInt64`) - Account id.
- **`accountSequence`** (`UInt64`) - Account sequence.
- **`effects`** (`Array<Effect>`) - Array of effects ([**Effects**](effects.md))


If some quantum changes state of an account, alpha will send **EffectsNotification** message. It implements 
**IQuantumInfoContainer** and doesn't have additional fields.


### Internal messages

**AuditorHandshakeResponse** - respond to **HandshakeRequest** with additional auditor data. Structure:

- **`handshakeData`** (`Array<byte>`) - Random 32 byte array generated by Alpha and signed by the auditor. 
- **`quantaCursor`** (`UInt64`) - Last known quantum apex to start sync from.
- **`resultCursor`** (`UInt64`) - Last known result apex to start sync from.
- **`state`** (`State`) - Current auditor state.


On every state changes, auditor sends **StateUpdateMessage** to constellation. **StateUpdateMessage** structure:
- **`state`** (`State`) - Auditor current state. 


**State** values:
- `Undefined` = `0` - Auditor is not initialized yet.
- `Running` = `1` - Auditor is running, but not ready to accept client connections.
- `Ready` = `2` - Auditor is ready to handle quantum requests.
- `Rising` = `3` - Auditor is collecting and validating pending quanta.
- `Chasing` = `4` - Auditor is too delayed and is in sync mode.
- `Failed` = `10` - Auditor failed.
- `Stopped` = `20` - Auditor is about to stop.


Each auditor streams its results to constellation by sending **AuditorResultsBatch**. Structure:
- **`auditorResultMessages`** (`Array<AuditorResult>`) - Array of quantum results. 


**AuditorResult** structure:

- **`apex`** (`UInt64`) - Quantum apex.
- **`signature`** (`AuditorSignatureInternal`) - Auditor's signature.


**AuditorSignatureInternal** structure:

- **`auditorId`** (`Int32`) - Auditors id (index in constellation settings)
- **`signature`** (`Array<byte>`) - Signature.
- **`txSigner`** (`Array<byte>`) - Withdrawal signer.
- **`txSignature`** (`Array<byte>`) - Withdrawal signature.


**QuantaBatchRequest** structure:

- **`quantaCursor`** (`UInt64`) - Last known quantum apex to start sync from.
- **`resultCursor`** (`UInt64`) - Last known result apex to start sync from.


**QuantaBatch** structure:

- **`quanta`** (`Array<Quantum>`) - Array of quanta.
- **`signatures`** (`Array<QuantumSignatures>`) - Array of collected signatures.
- **`lastKnownApex`** (`UInt64`) - Last known apex.


**QuantumSignatures** structure:

- **`apex`** (`UInt64`) - Quantum apex.
- **`signatures`** (`Array<AuditorSignatureInternal>`) - Auditor signatures.


#### Alpha quanta

All alpha generated quanta are inherited from **Quantum**. 

**DepositQuantum** structure: 

- **`source`** (`DepositNotification`) - Payment source.

**DepositNotification** structure:

- **`provider`** (`string`) - Payment provider id.
- **`cursor`** (`string`) - Payment cursor.
- **`items`** (`Array<Deposit>`) - Deposit items. Single transaction could contain multiple payments.

**Deposit** structure:

- **`paymentResult`** (`Int32`) - Payment operation result. `Success = 0` and `Failed = 1`.
- **`transactionHash`** (`Array<byte>`) - Current transaction hash.
- **`asset`** (`string`) - Centaurus asset code.
- **`amount`** (`UInt64`) - Payment amount.
- **`destination`** (`Array<byte>`) - Account public key.


#### Constellation quanta

All constellation quantum requests are wrapped with **ConstellationQuantum** that is inherited from 
**Quantum**.

**ConstellationUpdate** structure:

- **`providers`** (`Array<ProviderSettings>`) - Array of providers settings.
- **`auditors`** (`Array<Auditor>`) - Array of auditor settings.
- **`minAccountBalance`** (`UInt64`) - Minimal account balance.
- **`minAllowedLotSize`** (`UInt64`) - Minimal order size.
- **`assets`** (`Array<AssetSettings>`) - Array of asset settings.
- **`requestRateLimits`** (`RequestRateLimits`) - Default client request rate limit settings.
- **`alpha`** (`Array<byte>`) - Alpha public ed25519 key.

**ProviderSettings** structure:
- **`provider`** (`string`) - Provider type (Stellar, Bitcoin, Ethereum etc).
- **`name`** (`string`) - Provider name. Same provider type can have several configurations.
- **`vault`** (`string`) - Providers vault account.
- **`initCursor`** (`string`) - Cursor to start listening payments from.
- **`assets`** (`Array<ProviderAsset>`) - Provider's assets settings.
- **`paymentSubmitDelay`** (`Int32`) - Payment submit delay in seconds. How long to wait before notify alpha about payment.

**ProviderAsset** structure:
- **`token`** (`string`) - Token code. Could be null for native assets.
- **`centaurusAsset`** (`string`) - Centaurus asset code to map to.
- **`isVirtual`** (`Boolean`) - Is non native asset.

**Auditor** structure:
- **`pubKey`** (`Array<byte>`) - Auditor public ed25519 key.
- **`address`** (`string`) - Domain address. Could be null for auditors with participation level `Auditor`

**AssetSettings** structure:
- **`code`** (`string`) - Centaurus asset code.
- **`isSuspended`** (`Boolean`) - Is asset suspended for any operations (except deposit).
- **`isQuoteAsset`** (`Boolean`) - Is current asset is a quote asset.

**RequestRateLimits** structure:
- **`minuteLimit`** (`UInt32`) - Maximum requests for a client in a minute.
- **`hourLimit`** (`UInt32`) - Maximum requests for a client in an hour.
  
**ConstellationQuantum** structure:
- **`requestEnvelope`** (`ConstellationMessageEnvelope`) - Original operation request received from a 
constellation.


## Message envelope

Every message is wrapped with envelope. There are three types of message envelope in Centaurus:
**MessageEnvelope**, **MessageEnvelopeSignless** and **ConstellationMessageEnvelope**. Each of it inherit 
**MessageEnvelopeBase**.


**MessageEnvelopeBase** structure:

- **`message`** (`Message`) - nested message.


**MessageEnvelope** contains single signature and used for sending any request that must be authorized. 
Structure: 
	
- **`signature`** (`Array<byte>`) - Message hash signature.


**MessageEnvelopeSignless** doesn't contain signature and used for messages that already contains 
signatures/proofs in the message itself. 


**ConstellationMessageEnvelope** is a type of envelope that used for all constellation quantum requests. 
Structure: 

- **`signatures`** (`Array<Array<byte>>`) - Auditor signatures.