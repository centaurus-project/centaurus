# Quantum structure and flow

### Quantum structure

All messages are inherited from [**Message**](messages.md). All quantum messages are inherited from 
**Quantum**. 

**Quantum** structure: 

- **`apex`** (`UInt64`) - The most recent quantum apex (sequence).
- **`prevHash`** (`Array<byte>`) - Previous quantum SHA256 hash.
- **`effectsProof`** (`Array<byte>`) - All quantum effects SHA256 hash.
- **`timestamp`** (`Int64`) - Alpha server timestamp when the quantum has been fully executed 
on Alpha.

There are three general types of quantum. Quanta generated by alpha, client quantum requests
(all quanta initialized by clients) and constellation quantum (quanta that are initialized by auditors). All
quanta that are generated by alpha don't have to be wrapped, and two others must be wrapped with 
corresponding quantum wrapper. 

Once the quantum is validated by Alpha, it assigns the apex, timestamp, previous hash, effects proof and 
other quantum specific fields upon execution, before signing and propagating it further to auditors.
An auditor in turn validates quantum alongside with the original request and sends 
an audit result back to Alpha.

When the result majority is reached, Alpha create an envelop containing the result message and 
all auditor signatures. The envelope is delivered back to the client, which verifies the signatures 
and marks the quantum as finalized.

#### Alpha quanta

All alpha generated quanta are inherited from **Quantum**. 

**DepositQuantum** structure: 

- **`source`** (`DepositNotification`) - Payment source.

**DepositNotification** structure:

- **`provider`** (`string`) - Payment provider id.
- **`cursor`** (`string`) - Payment cursor.
- **`items`** (`Array<Deposit>`) - Deposit items. Single transaction could contain multiple payments.

**Deposit** structure:

- **`paymentResult`** (`Int32`) - Payment operation result. `Success = 0` and `Failed = 1`.
- **`transactionHash`** (`Array<byte>`) - Current transaction hash.
- **`asset`** (`string`) - Centaurus asset code.
- **`amount`** (`UInt64`) - Payment amount.
- **`destination`** (`Array<byte>`) - Account public key.

#### Client quanta

All client quantum requests are inherited from **SequentialRequestMessage**. Alpha wraps it with sub class 
of abstract class **RequestQuantumBase**. In most cases client requests would be wrapped with 
**RequestQuantum**, that implements **RequestQuantumBase** and doesn't have any fields. All other cases are 
described below.

**SequentialRequestMessage** structure: 

- **`account`** (`UInt64`) - Account id.
- **`nonce`** (`UInt64`) - A sequential nonce provided by the client to prevent replay attacks.

**RequestQuantumBase** structure: 

- **`requestEnvelope`** (`MessageEnvelopeBase`) - Original operation request received from a 
client ([**MessageEnvelopeBase**](messages.md)).

**AccountDataRequest** doesn't have any fields, but it will be wrapped with **AccountDataRequestQuantum** 
with following structure:

- **`payloadHash`** (`Array<byte>`) - Account's current state SHA256 hash.

**PaymentRequest** structure:

- **`asset`** (`string`) - Centaurus asset code.
- **`amount`** (`UInt64`) - Payment amount.
- **`destination`** (`Array<byte>`) - Destination public key.

**WithdrawalRequest** structure:

- **`provider`** (`string`) - Payment provider id.
- **`asset`** (`string`) - Centaurus asset code.
- **`amount`** (`UInt64`) - Payment amount.
- **`destination`** (`Array<byte>`) - Destination public key.
- **`fee`** (`UInt64`) - Transaction fee.

**WithdrawalRequest** will be wrapped with **WithdrawalRequestQuantum** with structure:

- **`transaction`** (`Array<byte>`) - Withdrawal transaction.
- **`provider`** (`string`) - Payment provider id.

**OrderRequest** structure:

- **`asset`** (`string`) - Centaurus asset code.
- **`side`** (`Int32`) - Order side. `Sell = 1` and `Buy = 2`
- **`amount`** (`UInt64`) - Order amount.
- **`price`** (`Float64`) - Asset price.
- **`timeInForce`** (`Int32`) - Order type. `GoodTillExpire = 0, ImmediateOrCancel = 1`.

**OrderCancellationRequest** structure:

- **`orderId`** (`UInt64`) - Order to cancel id.


#### Constellation quanta

All constellation quantum requests are wrapped with **ConstellationQuantum** that is inherited from 
**Quantum**.

**ConstellationUpdate** structure:

- **`providers`** (`Array<ProviderSettings>`) - Array of providers settings.
- **`auditors`** (`Array<Auditor>`) - Array of auditor settings.
- **`minAccountBalance`** (`UInt64`) - Minimal account balance.
- **`minAllowedLotSize`** (`UInt64`) - Minimal order size.
- **`assets`** (`Array<AssetSettings>`) - Array of asset settings.
- **`requestRateLimits`** (`RequestRateLimits`) - Default client request rate limit settings.
- **`alpha`** (`Array<byte>`) - Alpha public ed25519 key.

**ProviderSettings** structure:
- **`provider`** (`string`) - Provider type (Stellar, Bitcoin, Ethereum etc).
- **`name`** (`string`) - Provider name. Same provider type can have several configurations.
- **`vault`** (`string`) - Providers vault account.
- **`initCursor`** (`string`) - Cursor to start listening payments from.
- **`assets`** (`Array<ProviderAsset>`) - Provider's assets settings.
- **`paymentSubmitDelay`** (`Int32`) - Payment submit delay in seconds. How long to wait before notify alpha about payment.

**ProviderAsset** structure:
- **`token`** (`string`) - Token code. Could be null for native assets.
- **`centaurusAsset`** (`string`) - Centaurus asset code to map to.
- **`isVirtual`** (`Boolean`) - Is non native asset.

**Auditor** structure:
- **`pubKey`** (`Array<byte>`) - Auditor public ed25519 key.
- **`address`** (`string`) - Domain address. Could be null for auditors with participation level `Auditor`

**AssetSettings** structure:
- **`code`** (`string`) - Centaurus asset code.
- **`isSuspended`** (`Boolean`) - Is asset suspended for any operations (except deposit).
- **`isQuoteAsset`** (`Boolean`) - Is current asset is a quote asset.

**RequestRateLimits** structure:
- **`minuteLimit`** (`UInt32`) - Maximum requests for a client in a minute.
- **`hourLimit`** (`UInt32`) - Maximum requests for a client in an hour.
  
**ConstellationQuantum** structure:
- **`requestEnvelope`** (`ConstellationMessageEnvelope`) - Original operation request received from a 
constellation ([**ConstellationMessageEnvelope**](messages.md)).